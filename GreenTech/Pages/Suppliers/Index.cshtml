@page
@model GreenTech.Pages.Suppliers.IndexModel
@{
    ViewData["Title"] = "Quản lý Nhà cung cấp";
}

<div class="mb-6">
    <h1 class="text-3xl font-bold text-gray-900">Quản lý Nhà cung cấp</h1>
    <p class="text-gray-600 mt-2">Quản lý danh sách nhà cung cấp</p>
</div>

<div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
    <div class="flex items-center justify-between mb-6">
        <h2 class="text-xl font-semibold text-gray-900">Danh sách Nhà cung cấp</h2>
        <a asp-page="/Suppliers/Create" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-green-600 hover:bg-green-700">
            <svg class="-ml-1 mr-2 h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
            </svg>
            Thêm nhà cung cấp
        </a>
    </div>

    <!-- Search and Filter -->
    <form method="get" class="mb-6 flex items-center space-x-4">
        <div class="relative flex-1">
            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                <svg class="h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                </svg>
            </div>
            <input type="text" asp-for="QueryParams.SearchTerm" placeholder="Tìm kiếm tên, mã, email..." class="block w-full pl-10 pr-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-1 focus:ring-green-500 focus:border-green-500 sm:text-sm">
        </div>
        <select asp-for="QueryParams.IsActive" class="block w-auto pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm rounded-lg">
            <option value="">Tất cả</option>
            <option value="true">Hoạt động</option>
            <option value="false">Không hoạt động</option>
        </select>
        <select asp-for="QueryParams.SortBy" class="block w-auto pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm rounded-lg">
            <option value="">Sắp xếp</option>
            <option value="name">Theo tên</option>
            <option value="code">Theo mã</option>
            <option value="createdAt">Theo ngày tạo</option>
        </select>
        <button type="submit" class="px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700">Lọc</button>
    </form>

    <!-- Suppliers Table -->
    <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Mã</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tên nhà cung cấp</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Người liên hệ</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Điện thoại</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Trạng thái</th>
                    <th class="relative px-6 py-3"><span class="sr-only">Actions</span></th>
                </tr>
            </thead>
            <tbody id="suppliers-body" class="bg-white divide-y divide-gray-200">
                @if (Model.Suppliers != null && Model.Suppliers.Any())
                {
                    @foreach (var supplier in Model.Suppliers)
                    {
                        <tr class="hover:bg-gray-50" id="row-supplier-@supplier.Id" data-supplier-id="@supplier.Id">
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">@supplier.Code</td>
                            <td class="px-6 py-4 text-sm font-medium text-gray-900 max-w-xs truncate">@supplier.Name</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">@supplier.ContactPerson</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">@supplier.Email</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">@supplier.Phone</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm">
                                <span class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full @(supplier.IsActive ? "bg-green-100 text-green-800" : "bg-red-100 text-red-800")">
                                    @(supplier.IsActive ? "Hoạt động" : "Không hoạt động")
                                </span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                <a asp-page="./Edit" asp-route-id="@supplier.Id" class="text-indigo-600 hover:text-indigo-900 mr-3">Sửa</a>
                                <a asp-page="./Delete" asp-route-id="@supplier.Id" class="text-red-600 hover:text-red-900">Xóa</a>
                            </td>
                        </tr>
                    }
                }
                else
                {
                    <tr id="no-suppliers-row">
                        <td colspan="7" class="px-6 py-4 text-center text-sm text-gray-500">Không tìm thấy nhà cung cấp nào.</td>
                    </tr>
                }
            </tbody>
        </table>
    </div>

    <!-- Pagination -->
    @if (Model.TotalPages > 1)
    {
        <div class="mt-4 flex items-center justify-between">
            <div class="text-sm text-gray-700">
                Hiển thị <span class="font-medium">@((Model.QueryParams.PageNumber - 1) * Model.QueryParams.PageSize + 1)</span> - 
                <span class="font-medium">@Math.Min(Model.QueryParams.PageNumber * Model.QueryParams.PageSize, Model.TotalCount)</span> 
                trong tổng số <span class="font-medium">@Model.TotalCount</span> nhà cung cấp
            </div>
            <div class="flex gap-2">
                @if (Model.QueryParams.PageNumber > 1)
                {
                    <a asp-page="./Index" asp-route-pageNumber="@(Model.QueryParams.PageNumber - 1)" asp-route-searchTerm="@Model.QueryParams.SearchTerm" asp-route-isActive="@Model.QueryParams.IsActive" asp-route-sortBy="@Model.QueryParams.SortBy" 
                       class="px-3 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">Trước</a>
                }
                @for (int i = Math.Max(1, Model.QueryParams.PageNumber - 2); i <= Math.Min(Model.TotalPages, Model.QueryParams.PageNumber + 2); i++)
                {
                    <a asp-page="./Index" asp-route-pageNumber="@i" asp-route-searchTerm="@Model.QueryParams.SearchTerm" asp-route-isActive="@Model.QueryParams.IsActive" asp-route-sortBy="@Model.QueryParams.SortBy" 
                       class="px-3 py-2 border rounded-lg @(i == Model.QueryParams.PageNumber ? "bg-green-600 text-white border-green-600" : "border-gray-300 hover:bg-gray-50")">@i</a>
                }
                @if (Model.QueryParams.PageNumber < Model.TotalPages)
                {
                    <a asp-page="./Index" asp-route-pageNumber="@(Model.QueryParams.PageNumber + 1)" asp-route-searchTerm="@Model.QueryParams.SearchTerm" asp-route-isActive="@Model.QueryParams.IsActive" asp-route-sortBy="@Model.QueryParams.SortBy" 
                       class="px-3 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">Sau</a>
                }
            </div>
        </div>
    }
</div>

@section Scripts {
    <script>
        // Stop any old SignalR initialization if running
        if (window.supplierHubInitialized) {
            console.warn('Old SignalR initialization detected, stopping...');
        }
        window.supplierHubInitialized = true;
        
        console.log('Supplier SignalR script starting... v2.0');
        (function () {
            // Load SignalR script dynamically
            function loadSignalR() {
                console.log('loadSignalR() called');
                return new Promise((resolve, reject) => {
                    // Check if already loaded
                    if (window.signalR) {
                        console.log('SignalR already loaded');
                        resolve();
                        return;
                    }
                    console.log('SignalR not found, loading script...');
                    
                    // Check if script tag already exists
                    const existingScript = document.querySelector('script[src*="signalr"]');
                    if (existingScript) {
                        existingScript.addEventListener('load', () => {
                            if (window.signalR) {
                                resolve();
                            } else {
                                reject(new Error('SignalR script loaded but window.signalR is not available'));
                            }
                        });
                        existingScript.addEventListener('error', () => reject(new Error('Failed to load SignalR script')));
                        return;
                    }
                    
                    // Create and load script tag
                    const script = document.createElement('script');
                    script.src = 'https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/7.0.12/signalr.min.js';
                    script.crossOrigin = 'anonymous';
                    script.referrerPolicy = 'no-referrer';
                    script.onload = () => {
                        if (window.signalR) {
                            console.log('SignalR script loaded successfully');
                            resolve();
                        } else {
                            reject(new Error('SignalR script loaded but window.signalR is not available'));
                        }
                    };
                    script.onerror = () => reject(new Error('Failed to load SignalR script from CDN'));
                    document.head.appendChild(script);
                });
            }
            
            function initializeSupplierHub() {
                console.log('SignalR loaded, initializing SupplierHub connection...');
                const connection = new signalR.HubConnectionBuilder()
                    .withUrl('/hubs/supplier')
                    .withAutomaticReconnect()
                    .build();

                connection.onreconnecting(error => console.warn('SupplierHub reconnecting...', error));
                connection.onreconnected(id => console.info('SupplierHub reconnected', id));
                connection.onclose(error => console.warn('SupplierHub connection closed', error));

                function statusPill(isActive) {
                    return `<span class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full ${isActive ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">${isActive ? 'Hoạt động' : 'Không hoạt động'}</span>`;
                }

                function rowHtml(s) {
                    return `
                    <tr class="hover:bg-gray-50" id="row-supplier-${s.supplierId}" data-supplier-id="${s.supplierId}">
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${s.code || ''}</td>
                        <td class="px-6 py-4 text-sm font-medium text-gray-900 max-w-xs truncate">${s.name || ''}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${s.contactPerson || ''}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${s.email || ''}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${s.phone || ''}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm">${statusPill(!!s.isActive)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                            <a href="/Suppliers/Edit?id=${s.supplierId}" class="text-indigo-600 hover:text-indigo-900 mr-3">Sửa</a>
                            <a href="/Suppliers/Delete?id=${s.supplierId}" class="text-red-600 hover:text-red-900">Xóa</a>
                        </td>
                    </tr>`;
                }

                // Đăng ký event handler TRƯỚC KHI start connection
                connection.on('SupplierChanged', function (payload) {
                    console.log('SupplierChanged event received:', payload);
                    if (!payload) {
                        console.warn('Empty payload received');
                        return;
                    }
                    
                    const tbody = document.getElementById('suppliers-body');
                    if (!tbody) {
                        console.warn('suppliers-body element not found');
                        return;
                    }
                    
                    const supplierId = payload.supplierId || payload.id;
                    if (!supplierId) {
                        console.warn('No supplierId in payload:', payload);
                        return;
                    }
                    
                    const existingRow = document.getElementById('row-supplier-' + supplierId);
                    const noSuppliersRow = document.getElementById('no-suppliers-row');
                    
                    if (payload.action === 'created') {
                        console.log('Adding new supplier:', supplierId);
                        // Xóa dòng "Không tìm thấy" nếu có
                        if (noSuppliersRow) {
                            noSuppliersRow.remove();
                        }
                        
                        // Chỉ thêm nếu chưa tồn tại
                        if (!existingRow) {
                            const newRow = document.createElement('tr');
                            newRow.innerHTML = rowHtml(payload);
                            newRow.id = 'row-supplier-' + supplierId;
                            newRow.setAttribute('data-supplier-id', supplierId);
                            newRow.className = 'hover:bg-gray-50';
                            
                            // Thêm vào đầu bảng
                            tbody.insertBefore(newRow, tbody.firstChild);
                            console.log('New supplier row added successfully');
                        } else {
                            console.log('Supplier already exists, skipping');
                        }
                    } else if (payload.action === 'updated') {
                        console.log('Updating supplier:', supplierId);
                        if (existingRow) {
                            // Cập nhật các cell trong row
                            const cells = existingRow.querySelectorAll('td');
                            if (cells.length >= 6) {
                                if (payload.code !== undefined) cells[0].textContent = payload.code || '';
                                if (payload.name !== undefined) cells[1].textContent = payload.name || '';
                                if (payload.contactPerson !== undefined) cells[2].textContent = payload.contactPerson || '';
                                if (payload.email !== undefined) cells[3].textContent = payload.email || '';
                                if (payload.phone !== undefined) cells[4].textContent = payload.phone || '';
                                if (payload.isActive !== undefined) cells[5].innerHTML = statusPill(!!payload.isActive);
                            }
                            console.log('Supplier row updated successfully');
                        } else {
                            console.warn('Supplier row not found for update:', supplierId);
                        }
                    } else if (payload.action === 'deleted') {
                        console.log('Deleting supplier:', supplierId);
                        if (existingRow) {
                            existingRow.remove();
                            
                            // Nếu không còn row nào, hiển thị thông báo
                            const remainingRows = tbody.querySelectorAll('tr[data-supplier-id]');
                            if (remainingRows.length === 0) {
                                const noDataRow = document.createElement('tr');
                                noDataRow.id = 'no-suppliers-row';
                                noDataRow.innerHTML = '<td colspan="7" class="px-6 py-4 text-center text-sm text-gray-500">Không tìm thấy nhà cung cấp nào.</td>';
                                tbody.appendChild(noDataRow);
                            }
                            console.log('Supplier row deleted successfully');
                        } else {
                            console.warn('Supplier row not found for deletion:', supplierId);
                        }
                    }
                });

                // Start connection SAU KHI đã đăng ký event handler
                connection.start()
                    .then(() => {
                        console.info('✓ Connected to SupplierHub successfully');
                        console.info('Connection state:', connection.state);
                    })
                    .catch(err => {
                        console.error('✗ Error connecting to SupplierHub:', err);
                        console.error('Error details:', JSON.stringify(err));
                    });
            }

            // Đợi DOM ready và load SignalR
            function start() {
                console.log('Starting SignalR initialization...');
                loadSignalR()
                    .then(() => {
                        console.log('SignalR loaded, calling initializeSupplierHub...');
                        initializeSupplierHub();
                    })
                    .catch(err => {
                        console.error('Failed to load SignalR:', err);
                        console.error('Please check your internet connection and try refreshing the page.');
                    });
            }
            
            console.log('Document readyState:', document.readyState);
            if (document.readyState === 'loading') {
                console.log('Waiting for DOMContentLoaded...');
                document.addEventListener('DOMContentLoaded', start);
            } else {
                console.log('DOM already ready, starting immediately...');
                start();
            }
        })();
    </script>
}

