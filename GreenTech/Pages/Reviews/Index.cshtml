@page
@model GreenTech.Pages.Reviews.IndexModel
@{
    ViewData["Title"] = "Quản lý đánh giá";
}

<div class="mb-6">
    <h1 class="text-3xl font-bold text-gray-900">Quản lý Đánh giá</h1>
    <p class="text-gray-600 mt-2">Xem tất cả đánh giá sản phẩm của người dùng và phản hồi</p>
</div>

@if (TempData["SuccessMessage"] != null)
{
    <div class="mb-4 p-4 bg-green-50 border border-green-200 rounded-lg text-green-800">
        @TempData["SuccessMessage"]
    </div>
}

@if (TempData["ErrorMessage"] != null)
{
    <div class="mb-4 p-4 bg-red-50 border border-red-200 rounded-lg text-red-800">
        @TempData["ErrorMessage"]
    </div>
}

<div class="space-y-6">
    @if (Model.Reviews != null && Model.Reviews.Any())
    {
        @foreach (var review in Model.Reviews)
        {
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                <!-- Review Header -->
                <div class="flex items-start justify-between mb-4 pb-4 border-b border-gray-200">
                    <div class="flex-1">
                        <div class="flex items-center gap-3 mb-2">
                            <span class="text-sm font-semibold text-gray-900">@review.User?.FullName</span>
                            @if (review.IsAnonymous)
                            {
                                <span class="px-2 py-1 bg-gray-100 text-gray-600 text-xs rounded-full">Ẩn danh</span>
                            }
                        </div>
                        <div class="text-sm text-gray-600 mb-2">
                            <span class="font-medium">Sản phẩm:</span> @review.Product?.Name
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="text-sm text-gray-600">Đánh giá:</span>
                            <div class="flex items-center text-yellow-500">
                                @for (int i = 0; i < review.Rating; i++)
                                {
                                    <svg class="h-4 w-4" fill="currentColor" viewBox="0 0 20 20">
                                        <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.286 3.974a1 1 0 00.95.69h4.181c.969 0 1.371 1.24.588 1.81l-3.388 2.463a1 1 0 00-.364 1.118l1.287 3.974c.3.922-.755 1.688-1.54 1.118l-3.388-2.463a1 1 0 00-1.176 0l-3.388 2.463c-.784.57-1.838-.196-1.539-1.118l1.287-3.974a1 1 0 00-.364-1.118L2.274 9.401c-.783-.57-.38-1.81.588-1.81h4.181a1 1 0 00.95-.69l1.286-3.974z" />
                                    </svg>
                                }
                            </div>
                        </div>
                    </div>
                    <div class="text-right">
                        <span class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full @(review.Status == DAL.Models.Enum.ReviewStatus.APPROVED ? "bg-green-100 text-green-800" : "bg-yellow-100 text-yellow-800")">
                            @(review.Status == DAL.Models.Enum.ReviewStatus.APPROVED ? "Đã duyệt" : "Ẩn")
                        </span>
                        <form method="post" asp-page-handler="ToggleStatus" asp-route-id="@review.Id" class="inline ml-2">
                            <button type="submit"
                                    class="px-3 py-1 text-xs font-semibold rounded bg-blue-100 text-blue-800 hover:bg-blue-200 transition">
                                @(review.Status == DAL.Models.Enum.ReviewStatus.APPROVED ? "Ẩn" : "Duyệt")
                            </button>
                        </form>
                        <div class="text-xs text-gray-500 mt-2">@review.CreatedAt.ToString("dd/MM/yyyy HH:mm")</div>
                    </div>
                </div>

                <!-- Review Content -->
                @if (!string.IsNullOrEmpty(review.Content))
                {
                    <div class="mb-4 p-4 bg-gray-50 rounded-lg border-l-4 border-green-500">
                        <p class="text-gray-700 whitespace-pre-wrap">@review.Content</p>
                    </div>
                }

                <!-- Media URLs -->
                @if (!string.IsNullOrEmpty(review.MediaUrls))
                {
                    var mediaUrls = review.MediaUrls.Split(',', StringSplitOptions.RemoveEmptyEntries);
                    if (mediaUrls.Length > 0)
                    {
                        <div class="mb-4 flex gap-2 flex-wrap">
                            @foreach (var url in mediaUrls.Take(5))
                            {
                                <img src="@url.Trim()" alt="Review media" 
                                     class="w-20 h-20 object-cover rounded border border-gray-200 cursor-pointer hover:border-green-500"
                                     onclick="window.open('@url.Trim()', '_blank')" />
                            }
                        </div>
                    }
                }

                <!-- Replies Section -->
                <div class="mt-4 pt-4 border-t border-gray-200">
                    <h4 class="text-sm font-semibold text-gray-700 mb-3">
                        Phản hồi 
                        @if (review.ReviewReplies != null && review.ReviewReplies.Any())
                        {
                            <span>(@review.ReviewReplies.Count)</span>
                        }
                        else
                        {
                            <span>(0)</span>
                        }
                    </h4>

                    <!-- Existing Replies -->
                    @if (review.ReviewReplies != null && review.ReviewReplies.Any())
                    {
                        <div class="space-y-3 mb-4">
                            @foreach (var reply in review.ReviewReplies.OrderBy(r => r.CreatedAt))
                            {
                                var userRoles = reply.User?.UserRoles?.Select(ur => ur.Role?.RoleName).ToList() ?? new List<DAL.Models.Enum.RoleName?>();
                                var isAdmin = userRoles.Contains(DAL.Models.Enum.RoleName.ROLE_ADMIN);
                                var isStaff = userRoles.Contains(DAL.Models.Enum.RoleName.ROLE_STAFF);
                                
                                <div class="flex items-start gap-3 pl-4 border-l-4 border-green-500 bg-green-50 rounded-r-lg p-3">
                                    <div class="w-8 h-8 rounded-full bg-green-600 flex items-center justify-center flex-shrink-0">
                                        <i class="fas fa-user-tie text-white text-xs"></i>
                                    </div>
                                    <div class="flex-1">
                                        <div class="flex items-center gap-2 mb-1 flex-wrap">
                                            <span class="font-semibold text-sm text-gray-900">@reply.User?.FullName</span>
                                            @if (isAdmin)
                                            {
                                                <span class="px-2 py-0.5 bg-yellow-100 text-yellow-700 text-xs rounded-full font-medium">Admin</span>
                                            }
                                            @if (isStaff)
                                            {
                                                <span class="px-2 py-0.5 bg-green-100 text-green-700 text-xs rounded-full font-medium">Staff</span>
                                            }
                                            <span class="text-xs text-gray-500">@reply.CreatedAt.ToString("dd/MM/yyyy HH:mm")</span>
                                        </div>
                                        <p class="text-sm text-gray-700 leading-relaxed">@reply.Content</p>
                                    </div>
                                </div>
                            }
                        </div>
                    }

                    <!-- Reply Form -->
                    <form method="post" asp-page-handler="CreateReply" class="mt-4">
                        <input type="hidden" name="reviewId" value="@review.Id" />
                        <div class="flex gap-2">
                            <textarea name="content" 
                                      rows="2" 
                                      class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 resize-none"
                                      placeholder="Viết phản hồi cho đánh giá này..."
                                      required></textarea>
                            <button type="submit" 
                                    class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition font-medium">
                                <i class="fas fa-paper-plane mr-2"></i>Gửi
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        }
    }
    else
    {
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-12 text-center">
            <i class="fas fa-comments text-6xl text-gray-300 mb-4"></i>
            <h3 class="text-xl font-bold text-gray-800 mb-2">Chưa có đánh giá nào</h3>
            <p class="text-gray-600">Hiện tại chưa có đánh giá nào từ khách hàng.</p>
        </div>
    }
</div>