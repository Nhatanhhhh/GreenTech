@page "{id:int}"
@model GreenTech.Pages.Products.EditModel
@{
    ViewData["Title"] = "Sửa sản phẩm";
}

<div class="mb-6">
    <h1 class="text-3xl font-bold text-gray-900">Sửa sản phẩm</h1>
    <p class="text-gray-600 mt-2">Cập nhật thông tin sản phẩm</p>
    @if (Model.ProductDetails != null && !Model.ProductDetails.IsActive)
    {
        <div class="mt-3 bg-yellow-50 border-l-4 border-yellow-400 p-3 rounded-lg">
            <div class="flex items-center">
                <svg class="h-5 w-5 text-yellow-400 mr-2" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
                </svg>
                <p class="text-sm text-yellow-800 font-medium">Sản phẩm này đang bị vô hiệu hóa. Bạn có thể khôi phục bằng cách đánh dấu checkbox "Hoạt động" bên dưới.</p>
            </div>
        </div>
    }
</div>

<!-- Success/Error Messages -->
@if (TempData["SuccessMessage"] != null)
{
    <div id="successMessage" class="mb-4 bg-green-50 border-l-4 border-green-400 p-4 rounded-lg shadow-sm">
        <div class="flex items-center">
            <div class="flex-shrink-0">
                <svg class="h-5 w-5 text-green-400" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                </svg>
            </div>
            <div class="ml-3">
                <p class="text-sm font-medium text-green-800">@TempData["SuccessMessage"]</p>
            </div>
            <div class="ml-auto pl-3">
                <button onclick="document.getElementById('successMessage').remove()" class="text-green-400 hover:text-green-600">
                    <svg class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                    </svg>
                </button>
            </div>
        </div>
    </div>
    <script>
        setTimeout(function() {
            const successMsg = document.getElementById('successMessage');
            if (successMsg) {
                successMsg.style.opacity = '0';
                successMsg.style.transition = 'opacity 0.5s ease-out';
                setTimeout(function() {
                    successMsg.remove();
                }, 500);
            }
        }, 5000);
    </script>
}

@if (Model.Product == null)
{
    <div class="bg-red-50 border border-red-200 rounded-lg p-4">
        <p class="text-red-800">Không tìm thấy sản phẩm này.</p>
        <a asp-page="./Index" class="text-red-600 hover:underline mt-2 inline-block">Quay lại danh sách</a>
    </div>
}
else
{
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
        <form method="post" id="editProductForm">
            @Html.AntiForgeryToken()
            <input type="hidden" asp-for="Id" />
            <!-- Handler parameter để route đến OnPostUpdateAsync -->
            <input type="hidden" name="handler" value="Update" />
            
            <!-- Validation Summary với UI đẹp -->
            @if (!ViewData.ModelState.IsValid)
            {
                <div asp-validation-summary="All" class="mb-4 bg-red-50 border-l-4 border-red-400 p-4 rounded-lg shadow-sm">
                    <div class="flex items-start">
                        <div class="flex-shrink-0">
                            <svg class="h-5 w-5 text-red-400 mt-0.5" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                            </svg>
                        </div>
                        <div class="ml-3 flex-1">
                            <h3 class="text-sm font-medium text-red-800 mb-2">Vui lòng sửa các lỗi sau:</h3>
                            <ul class="list-disc list-inside space-y-1 text-sm text-red-700">
                                @foreach (var error in ViewData.ModelState.Values.SelectMany(v => v.Errors))
                                {
                                    <li>@error.ErrorMessage</li>
                                }
                            </ul>
                        </div>
                    </div>
                </div>
            }
            
            <div class="grid grid-cols-2 gap-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Tên sản phẩm *</label>
                    <input asp-for="Product.Name" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500" />
                    <span asp-validation-for="Product.Name" class="text-red-500 text-xs"></span>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Danh mục *</label>
                    <select asp-for="Product.CategoryId" asp-items="Model.Categories" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                        <option value="">Chọn danh mục</option>
                    </select>
                    <span asp-validation-for="Product.CategoryId" class="text-red-500 text-xs"></span>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Nhà cung cấp *</label>
                    <select asp-for="Product.SupplierId" asp-items="Model.Suppliers" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                        <option value="">Chọn nhà cung cấp</option>
                    </select>
                    <span asp-validation-for="Product.SupplierId" class="text-red-500 text-xs"></span>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Giá bán *</label>
                    <input asp-for="Product.SellPrice" type="number" step="0.01" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500" />
                    <span asp-validation-for="Product.SellPrice" class="text-red-500 text-xs"></span>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Giá vốn</label>
                    <input asp-for="Product.CostPrice" type="number" step="0.01" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500" />
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Số lượng</label>
                    <input asp-for="Product.Quantity" type="number" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500" />
                </div>

                <div class="col-span-2">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Mô tả *</label>
                    <textarea asp-for="Product.Description" rows="4" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 @(ViewData.ModelState["Product.Description"]?.Errors.Count > 0 ? "border-red-500" : "")">@(Model.Product?.Description ?? string.Empty)</textarea>
                    @if (ViewData.ModelState["Product.Description"]?.Errors.Count > 0)
                    {
                        <span class="flex items-center mt-1 text-xs text-red-600">
                            <svg class="h-4 w-4 mr-1" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
                            </svg>
                            <span asp-validation-for="Product.Description"></span>
                        </span>
                    }
                </div>

                <div class="col-span-2">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Mô tả ngắn</label>
                    <textarea asp-for="Product.ShortDescription" rows="2" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500"></textarea>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Kích thước cây</label>
                    <input asp-for="Product.PlantSize" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500" />
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Kích thước (Dimensions) *</label>
                    <input asp-for="Product.Dimensions" value="@(Model.Product?.Dimensions ?? string.Empty)" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 @(ViewData.ModelState["Product.Dimensions"]?.Errors.Count > 0 ? "border-red-500" : "")" placeholder="VD: 20x30x40 cm" />
                    @if (ViewData.ModelState["Product.Dimensions"]?.Errors.Count > 0)
                    {
                        <span class="flex items-center mt-1 text-xs text-red-600">
                            <svg class="h-4 w-4 mr-1" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
                            </svg>
                            <span asp-validation-for="Product.Dimensions"></span>
                        </span>
                    }
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Cân nặng (kg)</label>
                    <input asp-for="Product.Weight" type="number" step="0.01" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500" />
                    <span asp-validation-for="Product.Weight" class="text-red-500 text-xs"></span>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Điểm tích lũy</label>
                    <input asp-for="Product.PointsEarned" type="number" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500" />
                    <span asp-validation-for="Product.PointsEarned" class="text-red-500 text-xs"></span>
                </div>

                <div class="col-span-2">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Tags</label>
                    <input asp-for="Product.Tags" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500" placeholder="tag1, tag2, tag3" />
                </div>

                <div class="col-span-2">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Hướng dẫn chăm sóc</label>
                    <textarea asp-for="Product.CareInstructions" rows="4" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500"></textarea>
                </div>

                <div>
                    <label class="flex items-center">
                        <input asp-for="Product.IsFeatured" type="checkbox" class="rounded border-gray-300 text-green-600 focus:ring-green-500" />
                        <span class="ml-2 text-sm text-gray-700">Sản phẩm nổi bật</span>
                    </label>
                </div>

                <div>
                    <label class="flex items-center">
                        @if (Model.ProductDetails?.IsActive == true)
                        {
                            <!-- Product đang active: không cho phép deactivate qua Update, chỉ hiển thị thông tin -->
                            <input type="checkbox" checked disabled class="rounded border-gray-300 text-green-600 focus:ring-green-500" />
                            <span class="ml-2 text-sm text-gray-700">Hoạt động</span>
                            <input type="hidden" asp-for="Product.IsActive" value="true" />
                            <span class="ml-2 text-xs text-gray-500">(Không thể vô hiệu hóa qua Update, hãy dùng chức năng Xóa)</span>
                        }
                        else
                        {
                            <!-- Product đang inactive: cho phép restore -->
                            <input asp-for="Product.IsActive" type="checkbox" class="rounded border-gray-300 text-green-600 focus:ring-green-500" />
                            <span class="ml-2 text-sm text-gray-700">Hoạt động</span>
                            <span class="ml-2 text-xs text-blue-500">(Đánh dấu để khôi phục sản phẩm)</span>
                        }
                    </label>
                </div>
            </div>

            <div class="mt-6 flex gap-3">
                <button type="submit" asp-page-handler="Update" class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">Cập nhật</button>
                <a asp-page="./Index" class="px-6 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">Hủy</a>
            </div>
        </form>
    </div>
}

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
}

