@model DAL.DTOs.User.UserResponseDTO
@using DAL.DTOs.Order
@using DAL.Models.Enum
@{
    ViewData["Title"] = "Thông tin cá nhân";
}

<div class="container mx-auto max-w-4xl py-8 px-4">
    <div class="bg-white rounded-lg shadow-md border border-gray-200 p-8">
        <!-- Header -->
        <div class="flex items-center justify-between mb-6 border-b pb-4">
            <h1 class="text-2xl font-bold text-[#007934] font-['Roboto_Condensed'] uppercase">
                Thông tin cá nhân
            </h1>
            <div class="flex gap-3">
                <a asp-controller="Profile" asp-action="Update"
                    class="px-4 py-2 bg-[#007934] text-white rounded-md hover:bg-[#006028] transition-colors text-sm font-['Roboto']">
                    <i class="fas fa-edit mr-1"></i> Chỉnh sửa
                </a>
            </div>
        </div>

        <!-- Success/Error Messages -->
        @if (TempData["SuccessMessage"] != null)
        {
            <div class="mb-4 p-4 bg-green-100 border border-green-400 text-green-700 rounded-md">
                @TempData["SuccessMessage"]
            </div>
        }
        @if (TempData["ErrorMessage"] != null)
        {
            <div class="mb-4 p-4 bg-red-100 border border-red-400 text-red-700 rounded-md">
                @TempData["ErrorMessage"]
            </div>
        }

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <!-- Avatar Section -->
            <div class="md:col-span-1">
                <div class="flex flex-col items-center">
                    @if (!string.IsNullOrEmpty(Model.Avatar))
                    {
                        <img id="userAvatar" src="@Model.Avatar" alt="@Model.FullName"
                            class="w-32 h-32 rounded-full object-cover border-4 border-gray-200 mb-4">
                    }
                    else
                    {
                        <div id="avatarPlaceholder" class="w-32 h-32 rounded-full bg-gray-200 flex items-center justify-center mb-4">
                            <i class="fas fa-user text-6xl text-gray-400"></i>
                        </div>
                    }
                    <form id="uploadAvatarForm" enctype="multipart/form-data" class="w-full text-center">
                        @Html.AntiForgeryToken()
                        <label for="avatarFile" class="cursor-pointer">
                            <span
                                class="px-4 py-2 bg-gray-100 text-gray-700 rounded-md hover:bg-gray-200 transition-colors text-sm font-['Roboto'] inline-block">
                                <i class="fas fa-camera mr-1"></i> Đổi avatar
                            </span>
                            <input type="file" id="avatarFile" name="avatarFile" accept="image/*" class="hidden" />
                        </label>
                    </form>
                    <p class="text-sm text-gray-500 mt-2">Họ tên: <strong>@Model.FullName</strong></p>
                </div>
            </div>

            <!-- Profile Information -->
            <div class="md:col-span-2 space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1 font-['Roboto']">Email</label>
                        <p class="text-gray-900 bg-gray-50 p-2 rounded-md">@Model.Email</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1 font-['Roboto']">Số điện
                            thoại</label>
                        <p class="text-gray-900 bg-gray-50 p-2 rounded-md">@Model.Phone</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1 font-['Roboto']">Tỉnh/Thành
                            phố</label>
                        <p class="text-gray-900 bg-gray-50 p-2 rounded-md">@Model.Province</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1 font-['Roboto']">Quận/Huyện</label>
                        <p class="text-gray-900 bg-gray-50 p-2 rounded-md">@Model.District</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1 font-['Roboto']">Phường/Xã</label>
                        <p class="text-gray-900 bg-gray-50 p-2 rounded-md">@Model.Ward</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1 font-['Roboto']">Địa chỉ cụ
                            thể</label>
                        <p class="text-gray-900 bg-gray-50 p-2 rounded-md">@(string.IsNullOrEmpty(Model.SpecificAddress)
                                                        ? "Chưa có" : Model.SpecificAddress)</p>
                    </div>
                </div>

                <!-- Account Stats -->
                <div class="grid grid-cols-2 gap-4 mt-6 pt-6 border-t">
                    <div class="bg-blue-50 p-4 rounded-md">
                        <p class="text-sm text-gray-600 font-['Roboto']">Điểm tích lũy</p>
                        <p class="text-2xl font-bold text-blue-700">@Model.Points</p>
                    </div>
                    <div class="bg-green-50 p-4 rounded-md">
                        <p class="text-sm text-gray-600 font-['Roboto']">Số dư ví</p>
                        <p class="text-2xl font-bold text-green-700">@Model.WalletBalance.ToString("N0") ₫</p>
                    </div>
                </div>

                <!-- Actions -->
                <div class="mt-6 pt-6 border-t">
                    <a asp-controller="Profile" asp-action="ChangePassword"
                        class="inline-block px-4 py-2 bg-gray-100 text-gray-700 rounded-md hover:bg-gray-200 transition-colors text-sm font-['Roboto']">
                        <i class="fas fa-lock mr-1"></i> Đổi mật khẩu
                    </a>
                </div>
            </div>
        </div>

        <!-- Orders Section -->
        <div class="mt-8 bg-white rounded-lg shadow-md border border-gray-200 p-8">
            <div class="flex items-center justify-between mb-6 border-b pb-4">
                <h2 class="text-xl font-bold text-[#007934] font-['Roboto_Condensed'] uppercase">
                    <i class="fas fa-shopping-bag mr-2"></i>Đơn hàng của tôi
                </h2>
                <a asp-controller="Orders" asp-action="Index"
                    class="px-4 py-2 bg-[#007934] text-white rounded-md hover:bg-[#006028] transition-colors text-sm font-['Roboto']">
                    <i class="fas fa-list mr-1"></i> Xem tất cả đơn hàng
                </a>
            </div>

            @{
                var recentOrders = ViewBag.RecentOrders as IEnumerable<OrderResponseDTO>;
            }

            @if (recentOrders != null && recentOrders.Any())
            {
                <div class="space-y-4">
                    @foreach (var order in recentOrders)
                    {
                        <div class="bg-gray-50 rounded-lg p-4 border border-gray-200 hover:shadow-md transition-shadow">
                            <div class="flex justify-between items-start">
                                <div class="flex-1">
                                    <div class="flex items-center gap-3 mb-2">
                                        <h3 class="text-lg font-semibold text-gray-900 font-['Roboto']">
                                            Đơn hàng #@order.OrderNumber
                                        </h3>
                                        @{
                                            var statusClass = order.Status switch
                                            {
                                                OrderStatus.PENDING => "bg-yellow-100 text-yellow-800",
                                                OrderStatus.CONFIRMED => "bg-blue-100 text-blue-800",
                                                OrderStatus.PROCESSING => "bg-purple-100 text-purple-800",
                                                OrderStatus.SHIPPED => "bg-indigo-100 text-indigo-800",
                                                OrderStatus.DELIVERED => "bg-green-100 text-green-800",
                                                OrderStatus.CANCELLED => "bg-red-100 text-red-800",
                                                _ => "bg-gray-100 text-gray-800"
                                            };
                                            var statusText = order.Status switch
                                            {
                                                OrderStatus.PENDING => "Chờ xử lý",
                                                OrderStatus.CONFIRMED => "Đã xác nhận",
                                                OrderStatus.PROCESSING => "Đang xử lý",
                                                OrderStatus.SHIPPED => "Đang giao",
                                                OrderStatus.DELIVERED => "Đã giao",
                                                OrderStatus.CANCELLED => "Đã hủy",
                                                _ => order.Status.ToString()
                                            };
                                        }
                                        <span class="px-3 py-1 rounded-full text-xs font-medium @statusClass font-['Roboto']">
                                            @statusText
                                        </span>
                                    </div>
                                    <p class="text-sm text-gray-600 font-['Roboto'] mb-2">
                                        <i class="far fa-calendar mr-1"></i>Ngày đặt: @order.CreatedAt.ToString("dd/MM/yyyy HH:mm")
                                    </p>
                                    <p class="text-sm text-gray-600 font-['Roboto'] mb-3">
                                        <i class="fas fa-box mr-1"></i>@order.OrderItems.Count() sản phẩm - 
                                        <span class="font-semibold text-green-600">@order.Total.ToString("N0") ₫</span>
                                    </p>
                                    <div class="flex gap-2 mt-3">
                                        <a asp-controller="Orders" asp-action="Details" asp-route-id="@order.Id"
                                            class="px-3 py-1.5 bg-blue-600 hover:bg-blue-700 text-white rounded-md text-sm font-['Roboto'] transition-colors">
                                            <i class="fas fa-eye mr-1"></i> Xem chi tiết
                                        </a>
                                        @if (order.Status == OrderStatus.PENDING || order.Status == OrderStatus.CONFIRMED)
                                        {
                                            <a asp-controller="Orders" asp-action="Details" asp-route-id="@order.Id" 
                                               class="px-3 py-1.5 bg-red-600 hover:bg-red-700 text-white rounded-md text-sm font-['Roboto'] transition-colors">
                                                <i class="fas fa-times mr-1"></i> Hủy đơn
                                            </a>
                                        }
                                    </div>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            }
            else
            {
                <div class="text-center py-8">
                    <i class="fas fa-shopping-bag text-6xl text-gray-300 mb-4"></i>
                    <p class="text-gray-500 font-['Roboto'] mb-4">Bạn chưa có đơn hàng nào</p>
                    <a asp-controller="Products" asp-action="Index"
                        class="inline-block px-6 py-2 bg-[#007934] text-white rounded-md hover:bg-[#006028] transition-colors font-['Roboto']">
                        <i class="fas fa-shopping-cart mr-1"></i> Mua sắm ngay
                    </a>
                </div>
            }
        </div>
    </div>
</div>

<!-- Toast Notification Container -->
<div id="toastContainer" class="fixed top-4 right-4 z-50 space-y-2"></div>

<style>
    .toast {
        min-width: 300px;
        max-width: 500px;
        padding: 1rem;
        border-radius: 0.5rem;
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        display: flex;
        align-items: center;
        gap: 0.75rem;
        animation: slideInRight 0.3s ease-out, fadeOut 0.3s ease-out 2.7s forwards;
    }

    .toast-success {
        background-color: #10b981;
        color: white;
    }

    .toast-error {
        background-color: #ef4444;
        color: white;
    }

    .toast-info {
        background-color: #3b82f6;
        color: white;
    }

    @@keyframes slideInRight {
        from {
            transform: translateX(100%);
            opacity: 0;
        }

        to {
            transform: translateX(0);
            opacity: 1;
        }
    }

    @@keyframes fadeOut {
        to {
            opacity: 0;
            transform: translateX(100%);
        }
    }

    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999;
    }

    .loading-spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #007934;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        animation: spin 1s linear infinite;
    }

    @@keyframes spin {
        0% {
            transform: rotate(0deg);
        }

        100% {
            transform: rotate(360deg);
        }
    }

    @@keyframes fadeIn {
        from {
            opacity: 0;
            transform: scale(0.9);
        }
        to {
            opacity: 1;
            transform: scale(1);
        }
    }
</style>

<script>
    // Toast notification function
    function showToast(message, type = 'info') {
        const container = document.getElementById('toastContainer');
        const toast = document.createElement('div');
        toast.className = `toast toast-${type}`;

        const icon = type === 'success' ? 'fa-check-circle' :
            type === 'error' ? 'fa-exclamation-circle' :
                'fa-info-circle';

        toast.innerHTML = `
            <i class="fas ${icon} text-xl"></i>
            <span class="flex-1">${message}</span>
            <button onclick="this.parentElement.remove()" class="ml-2 hover:opacity-75">
                <i class="fas fa-times"></i>
            </button>
        `;

        container.appendChild(toast);

        // Auto remove after 3 seconds
        setTimeout(() => {
            if (toast.parentElement) {
                toast.remove();
            }
        }, 3000);
    }

    // Loading overlay function
    function showLoading() {
        const overlay = document.createElement('div');
        overlay.id = 'loadingOverlay';
        overlay.className = 'loading-overlay';
        overlay.innerHTML = '<div class="loading-spinner"></div>';
        document.body.appendChild(overlay);
    }

    function hideLoading() {
        const overlay = document.getElementById('loadingOverlay');
        if (overlay) {
            overlay.remove();
        }
    }

    // Avatar upload handler
    document.getElementById('avatarFile').addEventListener('change', function (e) {
        const file = e.target.files[0];
        if (!file) return;

        // Validate file type
        const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/webp'];
        if (!allowedTypes.includes(file.type)) {
            showToast('Chỉ chấp nhận file ảnh với định dạng: JPG, JPEG, PNG, GIF, WEBP', 'error');
            e.target.value = '';
            return;
        }

        // Show loading
        showLoading();

        // Upload file
        const formData = new FormData();
        formData.append('avatarFile', file);

        // Get anti-forgery token - required for ValidateAntiForgeryToken
        const token = document.querySelector('input[name="__RequestVerificationToken"]');
        if (!token) {
            showToast('Lỗi bảo mật. Vui lòng tải lại trang.', 'error');
            hideLoading();
            e.target.value = '';
            return;
        }
        formData.append('__RequestVerificationToken', token.value);

        // Get upload URL
        const uploadUrl = '@Url.Action("UploadAvatar", "Profile")';

        // Debug: log URL to console
        console.log('Upload URL:', uploadUrl);

        fetch(uploadUrl, {
            method: 'POST',
            body: formData,
            // Don't set Content-Type header, let browser set it automatically for FormData
            // This ensures boundary is set correctly for multipart/form-data
        })
            .then(response => {
                if (!response.ok) {
                    // Handle HTTP errors
                    if (response.status === 404) {
                        throw new Error('Không tìm thấy API endpoint. Vui lòng thử lại sau.');
                    } else if (response.status === 500) {
                        throw new Error('Lỗi server. Vui lòng thử lại sau.');
                    }
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                hideLoading();
                if (data.success) {
                    // Update avatar image immediately
                    updateAvatarImage(data.avatarUrl);
                    showToast(data.message || 'Upload avatar thành công!', 'success');
                } else {
                    showToast(data.message || 'Upload thất bại. Vui lòng thử lại.', 'error');
                }
            })
            .catch(error => {
                hideLoading();
                console.error('Error:', error);
                let errorMessage = 'Đã có lỗi xảy ra khi upload avatar.';
                if (error.message) {
                    errorMessage = error.message;
                }
                showToast(errorMessage, 'error');
            })
            .finally(() => {
                e.target.value = '';
            });
    });

    // Function to update avatar image (reusable for both fetch response and SignalR)
    function updateAvatarImage(avatarUrl) {
        if (!avatarUrl) {
            console.warn('updateAvatarImage: avatarUrl is empty');
            return;
        }
        
        console.log('updateAvatarImage called with URL:', avatarUrl);
        
        // Try to find existing avatar image by ID first (more reliable)
        let img = document.getElementById('userAvatar');
        
        if (img) {
            // Update existing image with timestamp to force refresh
            console.log('Updating existing avatar image');
            img.src = avatarUrl + '?t=' + new Date().getTime();
            // Add fade effect
            img.style.opacity = '0.5';
            setTimeout(() => {
                img.style.opacity = '1';
                img.style.transition = 'opacity 0.3s ease-in-out';
            }, 100);
        } else {
            // If no avatar exists, replace placeholder with image
            const placeholder = document.getElementById('avatarPlaceholder');
            if (placeholder) {
                console.log('Replacing placeholder with avatar image');
                const newImg = document.createElement('img');
                newImg.id = 'userAvatar';
                newImg.src = avatarUrl + '?t=' + new Date().getTime();
                newImg.alt = '@Model.FullName';
                newImg.className = 'w-32 h-32 rounded-full object-cover border-4 border-gray-200 mb-4';
                newImg.style.animation = 'fadeIn 0.5s ease-in-out';
                placeholder.replaceWith(newImg);
            } else {
                console.error('updateAvatarImage: Could not find avatar image or placeholder element');
            }
        }
    }

    // SignalR connection for realtime avatar updates
    (function() {
        // Wait for SignalR to be available (might load after page script)
        function initializeSignalR() {
            if (!window.signalR) {
                console.warn('SignalR is not loaded, retrying in 500ms...');
                setTimeout(initializeSignalR, 500);
                return;
            }

            const userId = @(Model?.Id ?? 0); // Get user ID from model
            if (!userId || userId === 0) {
                console.warn('User ID not available for SignalR connection');
                return;
            }

            console.log('Initializing SignalR NotificationHub connection for user:', userId);

            // Create SignalR connection to notification hub
            const notificationConnection = new signalR.HubConnectionBuilder()
                .withUrl('/hubs/notification')
                .withAutomaticReconnect({
                    nextRetryDelayInMilliseconds: retryContext => {
                        if (retryContext.elapsedMilliseconds < 60000) {
                            // Retry every 2 seconds for first minute
                            return 2000;
                        }
                        // Then retry every 10 seconds
                        return 10000;
                    }
                })
                .build();

            // Set up event handlers BEFORE starting connection
            // Listen for avatar update events
            notificationConnection.on('AvatarUpdated', function(data) {
                console.log('AvatarUpdated event received via SignalR:', data);
                if (data && data.userId === userId && data.avatarUrl) {
                    console.log('Updating avatar via SignalR for user:', userId);
                    // Update avatar image in realtime (no toast message to avoid duplicate)
                    updateAvatarImage(data.avatarUrl);
                } else {
                    console.warn('AvatarUpdated event ignored:', data);
                }
            });

            // Listen for other notification types (extensible for future features)
            notificationConnection.on('Notification', function(data) {
                console.log('Notification received:', data);
                if (data && data.type && data.message) {
                    showToast(data.message, data.type);
                }
            });

            // Connection state handlers
            notificationConnection.onclose(error => {
                console.warn('SignalR NotificationHub connection closed', error);
            });

            notificationConnection.onreconnecting(error => {
                console.log('SignalR NotificationHub reconnecting...', error);
            });

            notificationConnection.onreconnected(connectionId => {
                console.log('SignalR NotificationHub reconnected:', connectionId);
                // Rejoin group after reconnection
                if (userId) {
                    notificationConnection.invoke('JoinUserGroup', userId)
                        .then(() => console.log('Rejoined user group after reconnect:', userId))
                        .catch(err => console.error('Error rejoining group:', err));
                }
            });

            // Start connection and join user group
            notificationConnection.start()
                .then(() => {
                    console.log('SignalR NotificationHub connected successfully');
                    // Join user-specific group for personalized notifications
                    return notificationConnection.invoke('JoinUserGroup', userId);
                })
                .then(() => {
                    console.log('Successfully joined user group: user-' + userId);
                })
                .catch(err => {
                    console.error('SignalR NotificationHub connection error:', err);
                });

            // Expose connection globally for other pages/features
            window.__notificationHubConnection = notificationConnection;

            // Cleanup on page unload
            window.addEventListener('beforeunload', () => {
                if (notificationConnection) {
                    notificationConnection.stop();
                }
            });
        }

        // Start initialization
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeSignalR);
        } else {
            // DOM already loaded
            initializeSignalR();
        }
    })();
</script>
