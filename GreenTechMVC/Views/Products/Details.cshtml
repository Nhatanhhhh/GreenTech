@using DAL.DTOs.Product
@{
    ViewData["Title"] = ViewBag.Product?.Name ?? "Chi tiết sản phẩm";
    var product = ViewBag.Product as ProductResponseDTO;
    var relatedProducts = ViewBag.RelatedProducts as IEnumerable<ProductResponseDTO> ?? new List<ProductResponseDTO>();
}

@if (product != null)
{
    <div class="container mx-auto px-4 py-8">
        <!-- Product Details -->
        <div class="grid grid-cols-1 gap-8 lg:grid-cols-2">
            <!-- Product Images -->
            <div class="rounded-lg bg-white p-4 shadow-md">
                <!-- Main Image -->
                <img id="mainProductImage"
                    src="@(!string.IsNullOrEmpty(product.Image) ? product.Image : "/images/no-image.png")"
                    alt="@product.Name" class="w-full rounded-lg cursor-pointer transition-opacity duration-300">

                <!-- Thumbnail Images -->
                @if (product.ProductImages.Any())
                {
                    <div class="mt-4 grid grid-cols-4 gap-2">
                        <!-- Thumbnail for main image -->
                        <div class="thumbnail-item @(!string.IsNullOrEmpty(product.Image) ? "active" : "")"
                            data-image-src="@(!string.IsNullOrEmpty(product.Image) ? product.Image : "/images/no-image.png")">
                            <img src="@(!string.IsNullOrEmpty(product.Image) ? product.Image : "/images/no-image.png")"
                                alt="@product.Name"
                                class="h-20 w-full rounded object-cover cursor-pointer border-2 border-gray-300 hover:border-green-500 transition-all">
                        </div>
                        @foreach (var img in product.ProductImages.Take(3))
                        {
                            <div class="thumbnail-item" data-image-src="@img.ImageUrl">
                                <img src="@img.ImageUrl" alt="@img.AltText"
                                    class="h-20 w-full rounded object-cover cursor-pointer border-2 border-gray-300 hover:border-green-500 transition-all">
                            </div>
                        }
                    </div>
                }
                else if (!string.IsNullOrEmpty(product.Image))
                {
                    <!-- If no ProductImages but has main Image, still allow clicking main image -->
                    <div class="thumbnail-item active mt-4" data-image-src="@product.Image">
                        <img src="@product.Image" alt="@product.Name"
                            class="h-20 w-full rounded object-cover cursor-pointer border-2 border-green-500 transition-all">
                    </div>
                }
            </div>

            <!-- Product Info -->
            <div class="rounded-lg bg-white p-6 shadow-md">
                <h1 class="mb-4 text-3xl font-bold text-gray-800">@product.Name</h1>

                <div class="mb-4">
                    <span class="text-3xl font-bold text-green-600">@product.SellPrice.ToString("N0") đ</span>
                    @if (product.CostPrice > 0 && product.CostPrice > product.SellPrice)
                    {
                        <span class="ml-2 text-lg text-gray-500 line-through">@product.CostPrice.ToString("N0") đ</span>
                    }
                </div>

                <div class="mb-6 border-t border-b border-gray-200 py-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <p class="text-sm text-gray-600">Danh mục</p>
                            <p class="font-semibold">@product.CategoryName</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600">Nhà cung cấp</p>
                            <p class="font-semibold">@product.SupplierName</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600">SKU</p>
                            <p class="font-semibold">@product.Sku</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600">Tồn kho</p>
                            <p class="font-semibold">@product.Quantity sản phẩm</p>
                        </div>
                    </div>
                </div>

                @if (!string.IsNullOrEmpty(product.ShortDescription))
                {
                    <p class="mb-4 text-gray-700">@product.ShortDescription</p>
                }

                <div class="mb-6 flex items-center gap-4">
                    <button type="button" id="btnAddToCart" data-product-id="@product.Id"
                        class="w-full rounded bg-green-600 px-6 py-3 text-white hover:bg-green-700">
                        <i class="fas fa-cart-plus mr-2"></i>Thêm vào giỏ hàng
                    </button>
                </div>

                @if (!string.IsNullOrEmpty(product.Description))
                {
                    <div class="border-t border-gray-200 pt-4">
                        <h3 class="mb-2 font-semibold text-gray-800">Mô tả sản phẩm</h3>
                        <p class="text-gray-600">@Html.Raw(product.Description)</p>
                    </div>
                }
            </div>
        </div>

        <!-- Reviews Section -->
        <div class="mt-12">
            <div id="reviews-section" data-product-id="@product.Id">
                <h2 class="mb-6 text-2xl font-bold text-gray-800">Đánh giá sản phẩm</h2>
                <div id="review-statistics" class="mb-6"></div>
                <div id="reviews-list" class="space-y-6"></div>
                <div id="review-pagination" class="mt-6 flex justify-center"></div>
            </div>
        </div>

        <!-- Related Products -->
        @if (relatedProducts.Any())
        {
            <div class="mt-12">
                <h2 class="mb-6 text-2xl font-bold text-gray-800">Sản phẩm liên quan</h2>
                <div class="grid grid-cols-1 gap-6 sm:grid-cols-2 lg:grid-cols-3">
                    @foreach (var relatedProduct in relatedProducts)
                    {
                        <div class="group overflow-hidden rounded-lg bg-white shadow-md transition-all hover:shadow-xl">
                            <a asp-controller="Products" asp-action="Details" asp-route-id="@relatedProduct.Id">
                                <img src="@(!string.IsNullOrEmpty(relatedProduct.Image) ? relatedProduct.Image : "/images/no-image.png")"
                                    alt="@relatedProduct.Name"
                                    class="h-64 w-full object-cover transition-transform group-hover:scale-110">
                                <div class="p-4">
                                    <h3 class="mb-2 text-lg font-semibold text-gray-800">@relatedProduct.Name</h3>
                                    <span class="text-xl font-bold text-green-600">@relatedProduct.SellPrice.ToString("N0") đ</span>
                                </div>
                            </a>
                        </div>
                    }
                </div>
            </div>
        }
    </div>
}
else
{
    <div class="container mx-auto px-4 py-12 text-center">
        <p class="text-gray-500">Không tìm thấy sản phẩm.</p>
        <a asp-controller="Products" asp-action="Index" class="mt-4 inline-block text-green-600 hover:text-green-700">
            Quay lại danh sách sản phẩm
        </a>
    </div>
}

@section Scripts {
    <script>
        (function () {
            // Image Gallery Functionality
            function initImageGallery() {
                var $mainImage = $('#mainProductImage');
                var $thumbnails = $('.thumbnail-item');

                if ($thumbnails.length === 0) return;

                $thumbnails.on('click', function () {
                    var $this = $(this);
                    var imageSrc = $this.data('image-src');

                    if (!imageSrc) return;

                    // Update main image with fade effect
                    $mainImage.fadeOut(200, function () {
                        $mainImage.attr('src', imageSrc).fadeIn(200);
                    });

                    // Update active thumbnail
                    $thumbnails.removeClass('active').find('img').removeClass('border-green-500').addClass('border-gray-300');
                    $this.addClass('active').find('img').removeClass('border-gray-300').addClass('border-green-500');
                });

                // Optional: Click main image to open in lightbox or zoom
                $mainImage.on('click', function () {
                    // You can add lightbox functionality here if needed
                    // For now, just log or do nothing
                });
            }

            // Add to Cart Functionality
            function postAddToCart(productId, quantity) {
                return $.ajax({
                    url: '@Url.Action("AddToCart", "Cart")',
                    type: 'POST',
                    data: {
                        productId: String(productId),
                        quantity: quantity || 1
                    }
                });
            }

            var $btn = $('#btnAddToCart');
            if ($btn.length) {
                $btn.on('click', function () {
                    var productId = $(this).data('product-id');
                    if (!productId) return;
                    postAddToCart(productId, 1)
                        .done(function (res) {
                            if (res && res.success) {
                                if (window.updateCartCount) window.updateCartCount();
                            } else if (res) {
                                if (res.message && res.message.toLowerCase().indexOf('đăng nhập') !== -1) {
                                    window.location.href = '@Url.Action("Login", "Auth")';
                                } else if (res.message) {
                                    alert(res.message);
                                }
                            }
                        })
                        .fail(function () { /* ignore */ });
                });
            }

            // Initialize image gallery when page loads
            initImageGallery();

            // Load Reviews
            loadReviews(@product.Id);
        })();

        // Reviews functionality
        let currentReviewPage = 1;
        const reviewPageSize = 10;

        async function loadReviews(productId, page = 1) {
            currentReviewPage = page;
            const reviewsList = document.getElementById('reviews-list');
            const paginationDiv = document.getElementById('review-pagination');
            const statsDiv = document.getElementById('review-statistics');

            // Show loading
            reviewsList.innerHTML = '<p class="text-center text-gray-500">Đang tải đánh giá...</p>';

            try {
                // Load statistics
                const statsResponse = await fetch(`/Reviews/GetStatistics?productId=${productId}`);
                const stats = await statsResponse.json();
                renderStatistics(stats, statsDiv);

                // Load reviews
                const response = await fetch(`/Reviews/GetReviews?productId=${productId}&page=${page}&pageSize=${reviewPageSize}`);
                const data = await response.json();

                if (data.reviews && data.reviews.length > 0) {
                    renderReviews(data.reviews, reviewsList);
                    renderPagination(data, paginationDiv, productId);
                } else {
                    reviewsList.innerHTML = '<p class="text-center text-gray-500 py-8">Chưa có đánh giá nào cho sản phẩm này.</p>';
                    paginationDiv.innerHTML = '';
                }
            } catch (error) {
                reviewsList.innerHTML = '<p class="text-center text-red-500 py-8">Có lỗi xảy ra khi tải đánh giá.</p>';
                console.error('Error loading reviews:', error);
            }
        }

        function renderStatistics(stats, container) {
            const avgRating = stats.averageRating || 0;
            const totalReviews = stats.totalReviews || 0;
            
            container.innerHTML = `
                <div class="bg-white rounded-lg shadow-md p-6">
                    <div class="flex items-center gap-8">
                        <div class="text-center">
                            <div class="text-4xl font-bold text-green-600">${avgRating.toFixed(1)}</div>
                            <div class="flex items-center justify-center gap-1 mt-1">
                                ${renderStars(avgRating)}
                            </div>
                            <div class="text-sm text-gray-500 mt-1">${totalReviews} đánh giá</div>
                        </div>
                        <div class="flex-1">
                            ${renderRatingBars(stats)}
                        </div>
                    </div>
                </div>
            `;
        }

        function renderRatingBars(stats) {
            const total = stats.totalReviews || 0;
            const ratings = [
                { level: 5, count: stats.rating5Count || 0 },
                { level: 4, count: stats.rating4Count || 0 },
                { level: 3, count: stats.rating3Count || 0 },
                { level: 2, count: stats.rating2Count || 0 },
                { level: 1, count: stats.rating1Count || 0 }
            ];

            return ratings.map(r => {
                const percentage = total > 0 ? (r.count / total) * 100 : 0;
                return `<div class="flex items-center gap-2 mb-2">
                            <span class="text-sm text-gray-600 w-12">${r.level} sao</span>
                            <div class="flex-1 bg-gray-200 rounded-full h-2">
                                <div class="bg-yellow-400 h-2 rounded-full" style="width: ${percentage}%"></div>
                            </div>
                            <span class="text-sm text-gray-600 w-12 text-right">${r.count}</span>
                        </div>`;
            }).join('');
        }

        function renderStars(rating) {
            let html = '';
            for (let i = 1; i <= 5; i++) {
                if (i <= Math.floor(rating)) {
                    html += '<i class="fas fa-star text-yellow-400"></i>';
                } else if (i === Math.ceil(rating) && rating % 1 !== 0) {
                    html += '<i class="fas fa-star-half-alt text-yellow-400"></i>';
                } else {
                    html += '<i class="far fa-star text-gray-300"></i>';
                }
            }
            return html;
        }

        function renderReviews(reviews, container) {
            if (reviews.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-500 py-8">Chưa có đánh giá nào.</p>';
                return;
            }

            container.innerHTML = reviews.map(review => `
                <div class="bg-white rounded-lg shadow-md p-6">
                    <div class="flex items-start gap-4">
                        <img src="${review.userAvatar || '/images/no-avatar.png'}" 
                             alt="${review.userName}" 
                             class="w-12 h-12 rounded-full object-cover">
                        <div class="flex-1">
                            <div class="flex items-center gap-2 mb-2">
                                <h4 class="font-semibold text-gray-900">${review.userName}</h4>
                                <div class="flex items-center gap-1">
                                    ${renderStars(review.rating)}
                                </div>
                                <span class="text-sm text-gray-500 ml-2">${formatDate(review.createdAt)}</span>
                            </div>
                            ${review.content ? `<p class="text-gray-700 mb-3">${escapeHtml(review.content)}</p>` : ''}
                            ${review.mediaUrls && review.mediaUrls.length > 0 ? `
                                <div class="flex gap-2 mb-3">
                                    ${review.mediaUrls.map(url => `
                                        <img src="${url}" alt="Review image" class="w-24 h-24 object-cover rounded cursor-pointer" onclick="window.open('${url}', '_blank')">
                                    `).join('')}
                                </div>
                            ` : ''}
                            ${review.replies && review.replies.length > 0 ? `
                                <div class="mt-4 pl-4 border-l-2 border-gray-200">
                                    ${review.replies.map(reply => `
                                        <div class="mb-3">
                                            <div class="flex items-center gap-2 mb-1">
                                                <strong class="text-sm font-semibold">${reply.userName}</strong>
                                                <span class="text-xs text-gray-500">${formatDate(reply.createdAt)}</span>
                                            </div>
                                            <p class="text-sm text-gray-700">${escapeHtml(reply.content)}</p>
                                        </div>
                                    `).join('')}
                                </div>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function renderPagination(data, container, productId) {
            if (data.totalPages <= 1) {
                container.innerHTML = '';
                return;
            }

            let html = '<div class="flex gap-2">';
            
            if (data.hasPreviousPage) {
                html += `<button onclick="loadReviews(${productId}, ${data.pageNumber - 1})" 
                        class="px-4 py-2 border border-gray-300 rounded-md hover:bg-gray-50">Trước</button>`;
            }

            for (let i = 1; i <= data.totalPages; i++) {
                if (i === data.pageNumber) {
                    html += `<button class="px-4 py-2 bg-green-600 text-white rounded-md">${i}</button>`;
                } else {
                    html += `<button onclick="loadReviews(${productId}, ${i})" 
                            class="px-4 py-2 border border-gray-300 rounded-md hover:bg-gray-50">${i}</button>`;
                }
            }

            if (data.hasNextPage) {
                html += `<button onclick="loadReviews(${productId}, ${data.pageNumber + 1})" 
                        class="px-4 py-2 border border-gray-300 rounded-md hover:bg-gray-50">Sau</button>`;
            }

            html += '</div>';
            container.innerHTML = html;
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('vi-VN', { year: 'numeric', month: 'long', day: 'numeric' });
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
}
